<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ text.chatbot_title }}</title>
  <style>
    /* your existing styles */

    #chatInput {
      width: 70%;
      padding: 8px;
      margin-top: 10px;
    }
    #sendBtn {
      padding: 8px 12px;
      margin-left: 5px;
      cursor: pointer;
    }
    #imageUpload {
      margin-top: 10px;
      display: none; /* Show only during image step */
    }
    #productList img {
      max-width: 100px;
      max-height: 80px;
      vertical-align: middle;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h3>{{ text.chatbot_title }}</h3>

  <div class="controls">
    <select id="langSelect" onchange="changeLang()">
      <option value="en" {% if lang == 'en' %}selected{% endif %}>English</option>
      <option value="hi" {% if lang == 'hi' %}selected{% endif %}>рд╣рд┐рдВрджреА</option>
      <option value="ta" {% if lang == 'ta' %}selected{% endif %}>родрооро┐ро┤рпН</option>
    </select>

    <button onclick="startChat()">ЁЯОд {{ text.ask_something }}</button>
  </div>

  <pre id="chatOutput"></pre>

  <!-- Text input for typed user messages -->
  <input type="text" id="chatInput" placeholder="{{ text.type_something }}" />
  <button id="sendBtn" onclick="sendTypedInput()">Send</button>

  <!-- Image upload input (hidden until needed) -->
  <input type="file" id="imageUpload" accept="image/*" />

  <h4>Products List:</h4>
  <div id="productList" style="background:#fff; border:1px solid #a5d6a7; border-radius:8px; padding:10px; max-height:300px; overflow-y:auto;">
    Loading products...
  </div>

  <script>
    let currentChatLang = "{{ lang }}";

    let addProductState = null;
    let newProduct = { name: '', description: '', price: '', stock: '', category: '', imageBase64: '' };

    const chatbotReplies = {
      en: {
        "hello": "Hello! How can I help you today?",
        "add product": "You can add products from the dashboard. What is the product name?",
        "logout": "Click on logout button on the top right.",
      },
      hi: {
        "рдирдорд╕реНрддреЗ": "рдирдорд╕реНрддреЗ! рдореИрдВ рдЖрдкрдХреА рдХреИрд╕реЗ рдорджрдж рдХрд░ рд╕рдХрддреА рд╣реВрдБ?",
        "рдЙрддреНрдкрд╛рдж рдЬреЛрдбрд╝реЗрдВ": "рдбреИрд╢рдмреЛрд░реНрдб рд╕реЗ рдЙрддреНрдкрд╛рдж рдЬреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВред рдХреГрдкрдпрд╛ рдЙрддреНрдкрд╛рдж рдХрд╛ рдирд╛рдо рдмрддрд╛рдПрдВред",
        "рд▓реЙрдЧрдЖрдЙрдЯ": "рдКрдкрд░ рджрд╛рдИрдВ рдУрд░ рд▓реЙрдЧрдЖрдЙрдЯ рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВред",
      },
      ta: {
        "ро╡рогроХрпНроХроорпН": "ро╡рогроХрпНроХроорпН! роЙроЩрпНроХро│рпБроХрпНроХрпБ роОрокрпНрокроЯро┐ роЙродро╡ро▓ро╛роорпН?",
        "рокрпКро░рпБро│рпН роЪрпЗро░рпНроХрпНроХ": "роЯро╛ро╖рпНрокрпЛро░рпНроЯро┐ро▓рпН рокрпКро░рпБроЯрпНроХро│рпИ роЪрпЗро░рпНроХрпНроХро▓ро╛роорпН. родропро╡рпБроЪрпЖропрпНродрпБ рокрпКро░рпБро│ро┐ройрпН рокрпЖропро░рпИ роХрпВро▒ро╡рпБроорпН.",
        "ро╡рпЖро│ро┐ропрпЗро▒рпБ": "роорпЗро▓рпН ро╡ро▓родрпБрокрпБро▒роорпН роЙро│рпНро│ Logout рокрпКродрпНродро╛ройрпИ роЕро┤рпБродрпНродро╡рпБроорпН.",
      }
    };

    function changeLang() {
      currentChatLang = document.getElementById('langSelect').value;
      addProductState = null;
      newProduct = { name: '', description: '', price: '', stock: '', category: '', imageBase64: '' };
      document.getElementById("chatOutput").textContent = "";
      document.getElementById('imageUpload').style.display = 'none';
      document.getElementById('chatInput').value = '';
    }

    function speakText(text, lang) {
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = { en: "en-IN", hi: "hi-IN", ta: "ta-IN" }[lang] || "en-IN";
      speechSynthesis.speak(msg);
    }

    function getChatbotResponse(input, lang) {
      const responses = chatbotReplies[lang] || {};
      for (const key in responses) {
        if (input.includes(key)) return responses[key];
      }
      return {
        en: "Sorry, I didnтАЩt understand.",
        hi: "рдорд╛рдлрд╝ рдХреАрдЬрд┐рдП, рдореИрдВ рд╕рдордЭ рдирд╣реАрдВ рдкрд╛рдИред",
        ta: "рооройрпНройро┐роХрпНроХро╡рпБроорпН, рокрпБро░ро┐ропро╡ро┐ро▓рпНро▓рпИ.",
      }[lang];
    }

    // Unified function to process input from text or voice
    function processUserInput(userInputRaw) {
      const userInput = userInputRaw.toLowerCase();

      if (!addProductState) {
        const addProductKeywords = {
          en: ["add product"],
          hi: ["рдЙрддреНрдкрд╛рдж рдЬреЛрдбрд╝реЗрдВ"],
          ta: ["рокрпКро░рпБро│рпН роЪрпЗро░рпНроХрпНроХ"]
        };

        if (addProductKeywords[currentChatLang].some(k => userInput.includes(k))) {
          addProductState = "name";

          const askProductNameText = {
            en: "Please tell me the product name.",
            hi: "рдХреГрдкрдпрд╛ рдЙрддреНрдкрд╛рдж рдХрд╛ рдирд╛рдо рдмрддрд╛рдПрдВред",
            ta: "родропро╡рпБроЪрпЖропрпНродрпБ рокрпКро░рпБро│ро┐ройрпН рокрпЖропро░рпИ роХрпВро▒ро╡рпБроорпН."
          };

          speakText(askProductNameText[currentChatLang], currentChatLang);
          document.getElementById("chatOutput").textContent = `ЁЯЧгя╕П ${userInputRaw}\nЁЯдЦ ${askProductNameText[currentChatLang]}`;
        } else {
          const response = getChatbotResponse(userInput, currentChatLang);
          document.getElementById("chatOutput").textContent = `ЁЯЧгя╕П ${userInputRaw}\nЁЯдЦ ${response}`;
          speakText(response, currentChatLang);
        }
      } else {
        // Product adding flow including image upload step
        switch(addProductState) {
          case "name":
            newProduct.name = userInputRaw;
            addProductState = "description";
            speakText({
              en: "Got it. Now please provide the description.",
              hi: "рдареАрдХ рд╣реИред рдЕрдм рдХреГрдкрдпрд╛ рд╡рд┐рд╡рд░рдг рджреЗрдВред",
              ta: "роЪро░ро┐. роЗрокрпНрокрпЛродрпБ ро╡ро┐ро│роХрпНроХродрпНродрпИ роХрпВро▒ро╡рпБроорпН."
            }[currentChatLang], currentChatLang);
            document.getElementById("chatOutput").textContent = `ЁЯЧгя╕П Product Name: ${userInputRaw}\nЁЯдЦ Please provide the description.`;
            break;

          case "description":
            newProduct.description = userInputRaw;
            addProductState = "price";
            speakText({
              en: "Thanks. What is the price?",
              hi: "рдзрдиреНрдпрд╡рд╛рджред рдХреАрдордд рдХреНрдпрд╛ рд╣реИ?",
              ta: "роиройрпНро▒ро┐. ро╡ро┐ро▓рпИ роОройрпНрой?"
            }[currentChatLang], currentChatLang);
            document.getElementById("chatOutput").textContent = `ЁЯЧгя╕П Description: ${userInputRaw}\nЁЯдЦ What is the price?`;
            break;

          case "price":
            newProduct.price = userInputRaw;
            addProductState = "stock";
            speakText({
              en: "How many items are in stock?",
              hi: "рд╕реНрдЯреЙрдХ рдореЗрдВ рдХрд┐рддрдиреЗ рдЖрдЗрдЯрдо рд╣реИрдВ?",
              ta: "роЪро┐ро▓ рокрпКро░рпБроЯрпНроХро│рпН роХро┐роЯрпИропро╛?"
            }[currentChatLang], currentChatLang);
            document.getElementById("chatOutput").textContent = `ЁЯЧгя╕П Price: ${userInputRaw}\nЁЯдЦ How many items are in stock?`;
            break;

          case "stock":
            newProduct.stock = userInputRaw;
            addProductState = "category";
            speakText({
              en: "Finally, what is the product category?",
              hi: "рдЕрдВрдд рдореЗрдВ, рдЙрддреНрдкрд╛рдж рдХреА рд╢реНрд░реЗрдгреА рдХреНрдпрд╛ рд╣реИ?",
              ta: "роЗро▒рпБродро┐ропро┐ро▓рпН, рокрпКро░рпБро│рпН ро╡роХрпИ роОройрпНрой?"
            }[currentChatLang], currentChatLang);
            document.getElementById("chatOutput").textContent = `ЁЯЧгя╕П Stock: ${userInputRaw}\nЁЯдЦ What is the product category?`;
            break;

          case "category":
            newProduct.category = userInputRaw;

            // Show image upload input now
            document.getElementById('imageUpload').style.display = 'inline-block';

            addProductState = "image";
            const askImageText = {
              en: "Please upload an image of the product.",
              hi: "рдХреГрдкрдпрд╛ рдЙрддреНрдкрд╛рдж рдХреА рдПрдХ рдЫрд╡рд┐ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВред",
              ta: "родропро╡рпБроЪрпЖропрпНродрпБ рокрпКро░рпБро│ро┐ройрпН рокроЯродрпНродрпИ рокродро┐ро╡рпЗро▒рпНро▒ро╡рпБроорпН."
            };
            speakText(askImageText[currentChatLang], currentChatLang);
            document.getElementById("chatOutput").textContent = `ЁЯЧгя╕П Category: ${userInputRaw}\nЁЯдЦ ${askImageText[currentChatLang]}`;
            break;

          case "image":
            // This state is handled by file input change event (below)
            break;
        }
      }
    }

    // Called when user clicks Send button for typed input
    function sendTypedInput() {
      const inputBox = document.getElementById('chatInput');
      const userInputRaw = inputBox.value.trim();
      if (!userInputRaw) return;
      processUserInput(userInputRaw);
      inputBox.value = '';
    }

    // Speech recognition setup (same as before)
    function startChat() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("Speech Recognition is not supported in this browser.");
        return;
      }
      const recognition = new SpeechRecognition();
      recognition.lang = { en: "en-IN", hi: "hi-IN", ta: "ta-IN" }[currentChatLang] || "en-IN";

      recognition.start();

      recognition.onresult = function(event) {
        const userInputRaw = event.results[0][0].transcript.trim();
        processUserInput(userInputRaw);
      };

      recognition.onerror = function(event) {
        speakText({
          en: "Sorry, I couldn't hear you. Please try again.",
          hi: "рдорд╛рдлрд╝ рдХреАрдЬрд┐рдП, рдореИрдВ рдЖрдкрдХреА рдЖрд╡рд╛рдЬрд╝ рд╕реБрди рдирд╣реАрдВ рдкрд╛рдИред рдХреГрдкрдпрд╛ рдлрд┐рд░ рд╕реЗ рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВред",
          ta: "рооройрпНройро┐роХрпНроХро╡рпБроорпН, роЙроЩрпНроХро│рпН роХрпБро░ро▓рпИ роХрпЗроЯрпНроХ роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ. роорпАрогрпНроЯрпБроорпН роорпБропро▒рпНроЪро┐роХрпНроХро╡рпБроорпН."
        }[currentChatLang], currentChatLang);
      };
    }

    // Handle image upload input change event
    document.getElementById('imageUpload').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) {
        alert("No file selected.");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        // e.target.result is base64 image string
        newProduct.imageBase64 = e.target.result;

        const confirmMsg = {
          en: `Adding product named ${newProduct.name} with image.`,
          hi: `${newProduct.name} рдирд╛рдордХ рдЙрддреНрдкрд╛рдж рдЫрд╡рд┐ рдХреЗ рд╕рд╛рде рдЬреЛрдбрд╝рд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИред`,
          ta: `${newProduct.name} роОройрпНро▒ рокрпКро░рпБро│рпН рокроЯроорпН роЙроЯройрпН роЪрпЗро░рпНроХрпНроХрокрпНрокроЯрпБроХро┐ро▒родрпБ.`
        }[currentChatLang];
        speakText(confirmMsg, currentChatLang);
        document.getElementById("chatOutput").textContent += `\nЁЯдЦ ${confirmMsg}`;

        // Hide image upload after selection
        document.getElementById('imageUpload').style.display = 'none';

        // Send product data including imageBase64 to backend
        fetch('/add_product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: newProduct.name,
            description: newProduct.description,
            price: parseFloat(newProduct.price) || 0,
            stock: parseInt(newProduct.stock) || 0,
            category: newProduct.category,
            imageBase64: newProduct.imageBase64
          })
        }).then(res => {
          if (res.ok) {
            const successMsg = {
              en: "Product added successfully.",
              hi: "рдЙрддреНрдкрд╛рдж рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛ред",
              ta: "рокрпКро░рпБро│рпН ро╡рпЖро▒рпНро▒ро┐роХро░рооро╛роХ роЪрпЗро░рпНроХрпНроХрокрпНрокроЯрпНроЯродрпБ."
            };
            speakText(successMsg[currentChatLang], currentChatLang);
            document.getElementById("chatOutput").textContent += "\nЁЯдЦ " + successMsg[currentChatLang];
            loadProducts();
          } else {
            const failMsg = {
              en: "Failed to add product.",
              hi: "рдЙрддреНрдкрд╛рдж рдЬреЛрдбрд╝рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓ред",
              ta: "рокрпКро░рпБро│рпН роЪрпЗро░рпНроХрпНроХ роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ."
            };
            speakText(failMsg[currentChatLang], currentChatLang);
            document.getElementById("chatOutput").textContent += "\nЁЯдЦ " + failMsg[currentChatLang];
          }
        }).catch(() => {
          const errorMsg = {
            en: "Error connecting to server.",
            hi: "рд╕рд░реНрд╡рд░ рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рдиреЗ рдореЗрдВ рддреНрд░реБрдЯрд┐ред",
            ta: "роЪро░рпНро╡ро░рпБроЯройрпН роЗрогрпИроХрпНроХрпБроорпН рокрпЛродрпБ рокро┐ро┤рпИ."
          };
          speakText(errorMsg[currentChatLang], currentChatLang);
          document.getElementById("chatOutput").textContent += "\nЁЯдЦ " + errorMsg[currentChatLang];
        });

        // Reset flow state
        addProductState = null;
        newProduct = { name: '', description: '', price: '', stock: '', category: '', imageBase64: '' };
      };

      reader.readAsDataURL(file);
    });

    function loadProducts() {
      fetch('/api/products')
        .then(res => res.json())
        .then(data => {
          if (data.products && data.products.length > 0) {
            let html = '<ul style="list-style:none; padding-left:0;">';
            data.products.forEach(p => {
              // If image available, show thumbnail
              const imgTag = p.imageBase64 ? `<img src="${p.imageBase64}" alt="${p.name}"/>` : '';
              html += `<li style="margin-bottom:8px;">${imgTag}<b>${p.name}</b> тАФ ${p.description} | тВ╣${p.price} | Stock: ${p.stock} | Category: ${p.category}</li>`;
            });
            html += '</ul>';
            document.getElementById('productList').innerHTML = html;
          } else {
            document.getElementById('productList').textContent = 'No products added yet.';
          }
        })
        .catch(() => {
          document.getElementById('productList').textContent = 'Failed to load products.';
        });
    }

    window.onload = loadProducts;
  </script>
</body>
</html>
