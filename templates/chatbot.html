<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ text.chatbot_title }}</title>
  <style>
    /* your existing styles */

    #chatInput {
      width: 70%;
      padding: 8px;
      margin-top: 10px;
    }
    #sendBtn {
      padding: 8px 12px;
      margin-left: 5px;
      cursor: pointer;
    }
    #imageUpload {
      margin-top: 10px;
      display: none; /* Show only during image step */
    }
    #productList img {
      max-width: 100px;
      max-height: 80px;
      vertical-align: middle;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h3>{{ text.chatbot_title }}</h3>

  <div class="controls">
    <select id="langSelect" onchange="changeLang()">
      <option value="en" {% if lang == 'en' %}selected{% endif %}>English</option>
      <option value="hi" {% if lang == 'hi' %}selected{% endif %}>‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
      <option value="ta" {% if lang == 'ta' %}selected{% endif %}>‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
    </select>

    <button onclick="startChat()">üé§ {{ text.ask_something }}</button>
  </div>

  <pre id="chatOutput"></pre>

  <!-- Text input for typed user messages -->
  <input type="text" id="chatInput" placeholder="{{ text.type_something }}" />
  <button id="sendBtn" onclick="sendTypedInput()">Send</button>

  <!-- Image upload input (hidden until needed) -->
  <input type="file" id="imageUpload" accept="image/*" />

  <h4>Products List:</h4>
  <div id="productList" style="background:#fff; border:1px solid #a5d6a7; border-radius:8px; padding:10px; max-height:300px; overflow-y:auto;">
    Loading products...
  </div>

  <script>
    let currentChatLang = "{{ lang }}";

    let addProductState = null;
    let newProduct = { name: '', description: '', price: '', stock: '', category: '', imageBase64: '' };

    const chatbotReplies = {
      en: {
        "hello": "Hello! How can I help you today?",
        "add product": "You can add products from the dashboard. What is the product name?",
        "logout": "Click on logout button on the top right.",
      },
      hi: {
        "‡§®‡§Æ‡§∏‡•ç‡§§‡•á": "‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§ï‡•à‡§∏‡•á ‡§Æ‡§¶‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•Ä ‡§π‡•Ç‡§Å?",
        "‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç": "‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§∏‡•á ‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§ú‡•ã‡§°‡§º ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§¨‡§§‡§æ‡§è‡§Ç‡•§",
        "‡§≤‡•â‡§ó‡§Ü‡§â‡§ü": "‡§ä‡§™‡§∞ ‡§¶‡§æ‡§à‡§Ç ‡§ì‡§∞ ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§",
      },
      ta: {
        "‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç": "‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç! ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡ØÅ‡Æï‡Øç‡Æï‡ØÅ ‡Æé‡Æ™‡Øç‡Æ™‡Æü‡Æø ‡Æâ‡Æ§‡Æµ‡Æ≤‡Ææ‡ÆÆ‡Øç?",
        "‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øç ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï": "‡Æü‡Ææ‡Æ∑‡Øç‡Æ™‡Øã‡Æ∞‡Øç‡Æü‡Æø‡Æ≤‡Øç ‡Æ™‡Øä‡Æ∞‡ØÅ‡Æü‡Øç‡Æï‡Æ≥‡Øà ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ≤‡Ææ‡ÆÆ‡Øç. ‡Æ§‡ÆØ‡Æµ‡ØÅ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡ØÅ ‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Æø‡Æ©‡Øç ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øà ‡Æï‡ØÇ‡Æ±‡Æµ‡ØÅ‡ÆÆ‡Øç.",
        "‡Æµ‡ØÜ‡Æ≥‡Æø‡ÆØ‡Øá‡Æ±‡ØÅ": "‡ÆÆ‡Øá‡Æ≤‡Øç ‡Æµ‡Æ≤‡Æ§‡ØÅ‡Æ™‡ØÅ‡Æ±‡ÆÆ‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥ Logout ‡Æ™‡Øä‡Æ§‡Øç‡Æ§‡Ææ‡Æ©‡Øà ‡ÆÖ‡Æ¥‡ØÅ‡Æ§‡Øç‡Æ§‡Æµ‡ØÅ‡ÆÆ‡Øç.",
      }
    };

    function changeLang() {
      currentChatLang = document.getElementById('langSelect').value;
      addProductState = null;
      newProduct = { name: '', description: '', price: '', stock: '', category: '', imageBase64: '' };
      document.getElementById("chatOutput").textContent = "";
      document.getElementById('imageUpload').style.display = 'none';
      document.getElementById('chatInput').value = '';
    }

    function speakText(text, lang) {
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = { en: "en-IN", hi: "hi-IN", ta: "ta-IN" }[lang] || "en-IN";
      speechSynthesis.speak(msg);
    }

    function getChatbotResponse(input, lang) {
      const responses = chatbotReplies[lang] || {};
      for (const key in responses) {
        if (input.includes(key)) return responses[key];
      }
      return {
        en: "Sorry, I didn‚Äôt understand.",
        hi: "‡§Æ‡§æ‡§´‡§º ‡§ï‡•Ä‡§ú‡§ø‡§è, ‡§Æ‡•à‡§Ç ‡§∏‡§Æ‡§ù ‡§®‡§π‡•Ä‡§Ç ‡§™‡§æ‡§à‡•§",
        ta: "‡ÆÆ‡Æ©‡Øç‡Æ©‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç, ‡Æ™‡ØÅ‡Æ∞‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà.",
      }[lang];
    }

    // Unified function to process input from text or voice
    function processUserInput(userInputRaw) {
      const userInput = userInputRaw.toLowerCase();

      if (!addProductState) {
        const addProductKeywords = {
          en: ["add product"],
          hi: ["‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç"],
          ta: ["‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øç ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï"]
        };

        if (addProductKeywords[currentChatLang].some(k => userInput.includes(k))) {
          addProductState = "name";

          const askProductNameText = {
            en: "Please tell me the product name.",
            hi: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§¨‡§§‡§æ‡§è‡§Ç‡•§",
            ta: "‡Æ§‡ÆØ‡Æµ‡ØÅ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡ØÅ ‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Æø‡Æ©‡Øç ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øà ‡Æï‡ØÇ‡Æ±‡Æµ‡ØÅ‡ÆÆ‡Øç."
          };

          speakText(askProductNameText[currentChatLang], currentChatLang);
          document.getElementById("chatOutput").textContent = `üó£Ô∏è ${userInputRaw}\nü§ñ ${askProductNameText[currentChatLang]}`;
        } else {
          const response = getChatbotResponse(userInput, currentChatLang);
          document.getElementById("chatOutput").textContent = `üó£Ô∏è ${userInputRaw}\nü§ñ ${response}`;
          speakText(response, currentChatLang);
        }
      } else {
        // Product adding flow including image upload step
        switch(addProductState) {
          case "name":
            newProduct.name = userInputRaw;
            addProductState = "description";
            speakText({
              en: "Got it. Now please provide the description.",
              hi: "‡§†‡•Ä‡§ï ‡§π‡•à‡•§ ‡§Ö‡§¨ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¶‡•á‡§Ç‡•§",
              ta: "‡Æö‡Æ∞‡Æø. ‡Æá‡Æ™‡Øç‡Æ™‡Øã‡Æ§‡ØÅ ‡Æµ‡Æø‡Æ≥‡Æï‡Øç‡Æï‡Æ§‡Øç‡Æ§‡Øà ‡Æï‡ØÇ‡Æ±‡Æµ‡ØÅ‡ÆÆ‡Øç."
            }[currentChatLang], currentChatLang);
            document.getElementById("chatOutput").textContent = `üó£Ô∏è Product Name: ${userInputRaw}\nü§ñ Please provide the description.`;
            break;

          case "description":
            newProduct.description = userInputRaw;
            addProductState = "price";
            speakText({
              en: "Thanks. What is the price?",
              hi: "‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶‡•§ ‡§ï‡•Ä‡§Æ‡§§ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?",
              ta: "‡Æ®‡Æ©‡Øç‡Æ±‡Æø. ‡Æµ‡Æø‡Æ≤‡Øà ‡Æé‡Æ©‡Øç‡Æ©?"
            }[currentChatLang], currentChatLang);
            document.getElementById("chatOutput").textContent = `üó£Ô∏è Description: ${userInputRaw}\nü§ñ What is the price?`;
            break;

          case "price":
            newProduct.price = userInputRaw;
            addProductState = "stock";
            speakText({
              en: "How many items are in stock?",
              hi: "‡§∏‡•ç‡§ü‡•â‡§ï ‡§Æ‡•á‡§Ç ‡§ï‡§ø‡§§‡§®‡•á ‡§Ü‡§á‡§ü‡§Æ ‡§π‡•à‡§Ç?",
              ta: "‡Æö‡Æø‡Æ≤ ‡Æ™‡Øä‡Æ∞‡ØÅ‡Æü‡Øç‡Æï‡Æ≥‡Øç ‡Æï‡Æø‡Æü‡Øà‡ÆØ‡Ææ?"
            }[currentChatLang], currentChatLang);
            document.getElementById("chatOutput").textContent = `üó£Ô∏è Price: ${userInputRaw}\nü§ñ How many items are in stock?`;
            break;

          case "stock":
            newProduct.stock = userInputRaw;
            addProductState = "category";
            speakText({
              en: "Finally, what is the product category?",
              hi: "‡§Ö‡§Ç‡§§ ‡§Æ‡•á‡§Ç, ‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§ï‡•Ä ‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?",
              ta: "‡Æá‡Æ±‡ØÅ‡Æ§‡Æø‡ÆØ‡Æø‡Æ≤‡Øç, ‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øç ‡Æµ‡Æï‡Øà ‡Æé‡Æ©‡Øç‡Æ©?"
            }[currentChatLang], currentChatLang);
            document.getElementById("chatOutput").textContent = `üó£Ô∏è Stock: ${userInputRaw}\nü§ñ What is the product category?`;
            break;

          case "category":
            newProduct.category = userInputRaw;

            // Show image upload input now
            document.getElementById('imageUpload').style.display = 'inline-block';

            addProductState = "image";
            const askImageText = {
              en: "Please upload an image of the product.",
              hi: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§ï‡•Ä ‡§è‡§ï ‡§õ‡§µ‡§ø ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç‡•§",
              ta: "‡Æ§‡ÆØ‡Æµ‡ØÅ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡ØÅ ‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Æø‡Æ©‡Øç ‡Æ™‡Æü‡Æ§‡Øç‡Æ§‡Øà ‡Æ™‡Æ§‡Æø‡Æµ‡Øá‡Æ±‡Øç‡Æ±‡Æµ‡ØÅ‡ÆÆ‡Øç."
            };
            speakText(askImageText[currentChatLang], currentChatLang);
            document.getElementById("chatOutput").textContent = `üó£Ô∏è Category: ${userInputRaw}\nü§ñ ${askImageText[currentChatLang]}`;
            break;

          case "image":
            // This state is handled by file input change event (below)
            break;
        }
      }
    }

    // Called when user clicks Send button for typed input
    function sendTypedInput() {
      const inputBox = document.getElementById('chatInput');
      const userInputRaw = inputBox.value.trim();
      if (!userInputRaw) return;
      processUserInput(userInputRaw);
      inputBox.value = '';
    }

    // Speech recognition setup (same as before)
    function startChat() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("Speech Recognition is not supported in this browser.");
        return;
      }
      const recognition = new SpeechRecognition();
      recognition.lang = { en: "en-IN", hi: "hi-IN", ta: "ta-IN" }[currentChatLang] || "en-IN";

      recognition.start();

      recognition.onresult = function(event) {
        const userInputRaw = event.results[0][0].transcript.trim();
        processUserInput(userInputRaw);
      };

      recognition.onerror = function(event) {
        speakText({
          en: "Sorry, I couldn't hear you. Please try again.",
          hi: "‡§Æ‡§æ‡§´‡§º ‡§ï‡•Ä‡§ú‡§ø‡§è, ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§∏‡•Å‡§® ‡§®‡§π‡•Ä‡§Ç ‡§™‡§æ‡§à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§",
          ta: "‡ÆÆ‡Æ©‡Øç‡Æ©‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç, ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æï‡ØÅ‡Æ∞‡Æ≤‡Øà ‡Æï‡Øá‡Æü‡Øç‡Æï ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà. ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç."
        }[currentChatLang], currentChatLang);
      };
    }

    // Handle image upload input change event
    document.getElementById('imageUpload').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) {
        alert("No file selected.");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        // e.target.result is base64 image string
        newProduct.imageBase64 = e.target.result;

        const confirmMsg = {
          en: `Adding product named ${newProduct.name} with image.`,
          hi: `${newProduct.name} ‡§®‡§æ‡§Æ‡§ï ‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§õ‡§µ‡§ø ‡§ï‡•á ‡§∏‡§æ‡§• ‡§ú‡•ã‡§°‡§º‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‡•§`,
          ta: `${newProduct.name} ‡Æé‡Æ©‡Øç‡Æ± ‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øç ‡Æ™‡Æü‡ÆÆ‡Øç ‡Æâ‡Æü‡Æ©‡Øç ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ.`
        }[currentChatLang];
        speakText(confirmMsg, currentChatLang);
        document.getElementById("chatOutput").textContent += `\nü§ñ ${confirmMsg}`;

        // Hide image upload after selection
        document.getElementById('imageUpload').style.display = 'none';

        // Send product data including imageBase64 to backend
        fetch('/add_product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: newProduct.name,
            description: newProduct.description,
            price: parseFloat(newProduct.price) || 0,
            stock: parseInt(newProduct.stock) || 0,
            category: newProduct.category,
            imageBase64: newProduct.imageBase64
          })
        }).then(res => {
          if (res.ok) {
            const successMsg = {
              en: "Product added successfully.",
              hi: "‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ‡•§",
              ta: "‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øç ‡Æµ‡ØÜ‡Æ±‡Øç‡Æ±‡Æø‡Æï‡Æ∞‡ÆÆ‡Ææ‡Æï ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ."
            };
            speakText(successMsg[currentChatLang], currentChatLang);
            document.getElementById("chatOutput").textContent += "\nü§ñ " + successMsg[currentChatLang];
            loadProducts();
          } else {
            const failMsg = {
              en: "Failed to add product.",
              hi: "‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§",
              ta: "‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Øç ‡Æö‡Øá‡Æ∞‡Øç‡Æï‡Øç‡Æï ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà."
            };
            speakText(failMsg[currentChatLang], currentChatLang);
            document.getElementById("chatOutput").textContent += "\nü§ñ " + failMsg[currentChatLang];
          }
        }).catch(() => {
          const errorMsg = {
            en: "Error connecting to server.",
            hi: "‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§",
            ta: "‡Æö‡Æ∞‡Øç‡Æµ‡Æ∞‡ØÅ‡Æü‡Æ©‡Øç ‡Æá‡Æ£‡Øà‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç ‡Æ™‡Øã‡Æ§‡ØÅ ‡Æ™‡Æø‡Æ¥‡Øà."
          };
          speakText(errorMsg[currentChatLang], currentChatLang);
          document.getElementById("chatOutput").textContent += "\nü§ñ " + errorMsg[currentChatLang];
        });

        // Reset flow state
        addProductState = null;
        newProduct = { name: '', description: '', price: '', stock: '', category: '', imageBase64: '' };
      };

      reader.readAsDataURL(file);
    });

    function loadProducts() {
      fetch('/api/products')
        .then(res => res.json())
        .then(data => {
          if (data.products && data.products.length > 0) {
            let html = '<ul style="list-style:none; padding-left:0;">';
            data.products.forEach(p => {
              // If image available, show thumbnail
              const imgTag = p.imageBase64 ? `<img src="${p.imageBase64}" alt="${p.name}"/>` : '';
              html += `<li style="margin-bottom:8px;">${imgTag}<b>${p.name}</b> ‚Äî ${p.description} | ‚Çπ${p.price} | Stock: ${p.stock} | Category: ${p.category}</li>`;
            });
            html += '</ul>';
            document.getElementById('productList').innerHTML = html;
          } else {
            document.getElementById('productList').textContent = 'No products added yet.';
          }
        })
        .catch(() => {
          document.getElementById('productList').textContent = 'Failed to load products.';
        });
    }

    window.onload = loadProducts;
  </script>
</body>
</html>
